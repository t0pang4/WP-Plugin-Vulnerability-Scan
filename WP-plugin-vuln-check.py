import os
import sys
import argparse
import json
import requests
import time
from datetime import date

apipath = "https://wpvulndb.com/api/v2/wordpresses/43"
cwd = os.getcwd()
date = str(date.today())
results = []

# create folder in cwd for results
if not os.path.exists(os.getcwd() + "/WP-vuln-scan_" + date):
    os.makedir(cwd + "/WP-vuln-scan_" + date, 0o777)


def get_scan_data():

    print('Initializing WordPress version scan....')
    results = requests.get(apipath)
    data = results.json()
    datad = data

    for key, value in datad.iteritems():
        e = data['4.3']['vulnerabilities']
        for each_dict in e:
            title = each_dict["title"]

        ref = each_dict["references"]
        cves = each_dict["references"]["cve"]
        for cve in cves:
            print "CVE: " + cve

        for innerk, innerv in each_dict.iteritems():
            if innerk == "title":
                print "Name: " + innerv
            if innerk == "vuln_type":
                print "Vulnerability Type: " + innerv
            if innerk == "references":
                for x, y in innerk.iteritems():
                    if x == "cve":
                        print "CVE: " + str(y)
            if innerk == "published_date":
                print "Date Published: " + innerv
            if innerk == "fixed_in":
                print "Fixed in version: " + str(innerv)
        print("\n\n")

    return data


# create command line arguments
parser = argparse.ArgumentParser(description="WP vuln scan")
parser.add_argument('-v', '--version', help='WordPress version to scan')
parser.add_argument('-p', '--plugin', help='WordPress plugin to scan')
parser.add_argument('-t', '--theme', help='WordPress theme to scan')
args = parser.parse_args()


def main():
    vulns = get_scan_data()
    file = open("WP-vuln-scan_" + date + "/" + "results.txt", "w")
    file.write(json.dumps(vulns, indent=2, sort_keys=True))


if __name__ == "__main__":
    main()
